{% extends "base.html" %}

{% block title %}Access Control - Security Access Control{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h3 class="mb-0">
                    <i class="fas fa-qrcode me-2"></i>
                    Access Control
                </h3>
            </div>
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <div class="access-scanner-icon mb-3">
                        <i class="fas fa-mobile-alt fa-4x text-primary"></i>
                    </div>
                    <h5>QR Code Scanner</h5>
                    <p class="text-muted">
                        Enter your QR Code ID below to verify access or use the camera scanner.
                    </p>
                </div>

                <!-- QR Code Input Form -->
                <form method="POST" action="{{ url_for('access_control') }}">
                    <div class="mb-4">
                        <label for="qr_code_id" class="form-label">QR Code ID</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-qrcode"></i>
                            </span>
                            <input type="text"
                                   class="form-control"
                                   id="qr_code_id"
                                   name="qr_code_id"
                                   placeholder="Enter or scan QR Code ID"
                                   autocomplete="off"
                                   autofocus
                                   required>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Present your QR code to the camera or enter the ID manually
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-check-circle me-2"></i>
                        Verify Access
                    </button>
                </form>

                <!-- Camera Scanner Section -->
                <div class="mt-4">
                    <hr>
                    <div class="text-center">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-camera me-2"></i>
                            Camera QR Scanner
                        </h6>
                        <button type="button" class="btn btn-outline-primary" id="startCamera" onclick="startCamera()">
                            <i class="fas fa-camera me-2"></i>
                            Start Camera Scanner
                        </button>
                        <button type="button" class="btn btn-outline-secondary d-none" id="stopCamera" onclick="stopCamera()">
                            <i class="fas fa-stop me-2"></i>
                            Stop Scanner
                        </button>
                        <div class="form-text mt-2">
                            Click to activate camera and scan QR codes automatically
                        </div>
                    </div>
                    
                    <!-- Camera Video Container -->
                    <div class="mt-3" id="cameraContainer" style="display: none;">
                        <div class="text-center">
                            <video id="qrVideo" width="300" height="200" style="border: 2px solid #ddd; border-radius: 8px;"></video>
                            <div class="mt-2">
                                <small class="text-muted">Position QR code within the camera view</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Instructions -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Access Instructions
                </h6>
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Check-in:</strong> Present your QR code when entering
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Check-out:</strong> Present your QR code when leaving
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        <strong>Denied:</strong> Contact security if access is denied
                    </li>
                    <li>
                        <i class="fas fa-ban text-danger me-2"></i>
                        <strong>Banned:</strong> Access restricted - contact administrator
                    </li>
                </ul>
            </div>
        </div>

        {% if current_user.is_authenticated %}
        <!-- Admin Quick Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-tools me-2"></i>
                    Admin Quick Actions
                </h6>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-users-cog me-1"></i>
                        Dashboard
                    </a>
                    <a href="{{ url_for('reports') }}" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-chart-bar me-1"></i>
                        Reports
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if scanned_user %}
        <div class="row mt-4">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user me-2"></i>
                            Scanned User Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                {% if scanned_user.picture_filename %}
                                    <img src="{{ url_for('static', filename='uploads/' + scanned_user.picture_filename) }}"
                                         alt="{{ scanned_user.full_name }}"
                                         class="img-fluid rounded-circle mb-3"
                                         style="width: 120px; height: 120px; object-fit: cover;">
                                {% else %}
                                    <div class="rounded-circle bg-secondary mx-auto mb-3 d-flex align-items-center justify-content-center"
                                         style="width: 120px; height: 120px;">
                                        <i class="fas fa-user fa-3x text-white"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <h4 class="mb-1">{{ scanned_user.full_name }}</h4>
                                        <p class="text-muted mb-0">ID: <code>{{ scanned_user.qr_code_id }}</code></p>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-6">
                                        <strong>Access Status:</strong><br>
                                        <span class="badge bg-{{ 'success' if scanned_user.status == 'allowed' else 'danger' }} fs-6">
                                            <i class="fas fa-{{ 'check' if scanned_user.status == 'allowed' else 'ban' }} me-1"></i>
                                            {{ scanned_user.status.title() }}
                                        </span>
                                    </div>
                                    <div class="col-sm-6">
                                        <strong>Current Status:</strong><br>
                                        <span class="badge bg-{{ 'warning' if scanned_user.is_checked_in else 'info' }} fs-6">
                                            <i class="fas fa-{{ 'sign-in-alt' if scanned_user.is_checked_in else 'sign-out-alt' }} me-1"></i>
                                            {{ 'Checked In' if scanned_user.is_checked_in else 'Checked Out' }}
                                        </span>
                                    </div>
                                </div>
                                {% if scanned_user.status != 'allowed' %}
                                <div class="alert alert-danger mt-3" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Access Denied!</strong> This user is currently {{ scanned_user.status }}.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
<script>
let qrScanner = null;
let videoElement = null;

function startCamera() {
    const startBtn = document.getElementById('startCamera');
    const stopBtn = document.getElementById('stopCamera');
    const cameraContainer = document.getElementById('cameraContainer');
    videoElement = document.getElementById('qrVideo');

    // Show camera container
    cameraContainer.style.display = 'block';
    startBtn.classList.add('d-none');
    stopBtn.classList.remove('d-none');

    // Initialize QR Scanner
    if (QrScanner.hasCamera()) {
        qrScanner = new QrScanner(
            videoElement,
            result => handleQRResult(result.data),
            {
                onDecodeError: error => {
                    // Silently handle decode errors (normal when no QR code is visible)
                },
                highlightScanRegion: true,
                highlightCodeOutline: true,
            }
        );

        qrScanner.start().then(() => {
            console.log('QR Scanner started successfully');
        }).catch(error => {
            console.error('Failed to start QR Scanner:', error);
            alert('Failed to access camera. Please ensure camera permissions are granted.');
            stopCamera();
        });
    } else {
        alert('No camera found on this device.');
        stopCamera();
    }
}

function stopCamera() {
    const startBtn = document.getElementById('startCamera');
    const stopBtn = document.getElementById('stopCamera');
    const cameraContainer = document.getElementById('cameraContainer');

    if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
        qrScanner = null;
    }

    // Hide camera container
    cameraContainer.style.display = 'none';
    startBtn.classList.remove('d-none');
    stopBtn.classList.add('d-none');
}

function handleQRResult(qrData) {
    // Stop the scanner
    stopCamera();

    // Set the QR code in the input field
    const input = document.getElementById('qr_code_id');
    input.value = qrData.toUpperCase();
    
    // Process the QR code via API for immediate response
    processQRCode(qrData.toUpperCase());
}

function processQRCode(qrCodeId) {
    // Show processing state
    const form = document.querySelector('form');
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;

    // Send AJAX request to process QR code
    fetch('/api/process_qr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ qr_code_id: qrCodeId })
    })
    .then(response => response.json())
    .then(data => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        if (data.success) {
            // Show success message and user details
            showUserDetails(data.user, data.message);
        } else {
            // Show error message
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        console.error('Error:', error);
        showAlert('Failed to process QR code. Please try again.', 'danger');
    });
}

function showUserDetails(user, message) {
    // Create or update user details display
    let userDetailsDiv = document.getElementById('userDetails');
    if (!userDetailsDiv) {
        userDetailsDiv = document.createElement('div');
        userDetailsDiv.id = 'userDetails';
        userDetailsDiv.className = 'mt-4';
        document.querySelector('.card-body').appendChild(userDetailsDiv);
    }

    const statusClass = user.status === 'allowed' ? 'success' : 'danger';
    const checkInStatus = user.is_checked_in ? 'Checked In' : 'Checked Out';
    const checkInIcon = user.is_checked_in ? 'sign-in-alt' : 'sign-out-alt';

    userDetailsDiv.innerHTML = `
        <div class="alert alert-${statusClass}" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-${statusClass === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
            </h5>
        </div>
        <div class="card border-${statusClass}">
            <div class="card-header bg-${statusClass} text-white">
                <h5 class="mb-0">User Details</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4 text-center">
                        ${user.picture_url ? 
                            `<img src="${user.picture_url}" alt="${user.full_name}" class="img-fluid rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">` :
                            `<div class="rounded-circle bg-secondary mx-auto mb-3 d-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>`
                        }
                    </div>
                    <div class="col-md-8">
                        <h4 class="mb-1">${user.full_name}</h4>
                        <p class="text-muted mb-2">ID: <code>${user.qr_code_id}</code></p>
                        <div class="row mb-2">
                            <div class="col-6">
                                <strong>Status:</strong>
                                <span class="badge bg-${statusClass} ms-1">${user.status.charAt(0).toUpperCase() + user.status.slice(1)}</span>
                            </div>
                            <div class="col-6">
                                <strong>Current:</strong>
                                <span class="badge bg-info ms-1">
                                    <i class="fas fa-${checkInIcon} me-1"></i>${checkInStatus}
                                </span>
                            </div>
                        </div>
                        ${user.qr_code_url ? 
                            `<div class="mt-3">
                                <a href="${user.qr_code_url}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-qrcode me-1"></i>View QR Code
                                </a>
                            </div>` : ''
                        }
                    </div>
                </div>
            </div>
        </div>
    `;

    // Scroll to user details
    userDetailsDiv.scrollIntoView({ behavior: 'smooth' });
}

function showAlert(message, type) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert after the form
    const form = document.querySelector('form');
    form.parentNode.insertBefore(alertDiv, form.nextSibling);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Auto-focus on QR code input when page loads
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('qr_code_id');
    if (input) {
        input.focus();

        // Clear input on focus for better UX
        input.addEventListener('focus', function() {
            if (this.value) {
                this.select();
            }
        });
    }
});

// Clean up camera when page is unloaded
window.addEventListener('beforeunload', function() {
    if (qrScanner) {
        qrScanner.stop();
        qrScanner.destroy();
    }
});
</script>
{% endblock %}