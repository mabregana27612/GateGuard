{% extends "base.html" %}

{% block title %}Edit Profile - Security Access Control{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Edit Profile
                </h3>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('edit_profile') }}" enctype="multipart/form-data">
                    <!-- Profile Picture -->
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            {% if user.profile_picture %}
                            <img src="{{ url_for('static', filename=user.profile_picture) }}" 
                                 alt="Profile Picture" 
                                 class="rounded-circle" 
                                 style="width: 120px; height: 120px; object-fit: cover;"
                                 id="profilePreview">
                            {% else %}
                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" 
                                 style="width: 120px; height: 120px;"
                                 id="profilePreview">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>
                            {% endif %}
                            
                            <button type="button" 
                                    class="btn btn-primary btn-sm position-absolute bottom-0 end-0 rounded-circle"
                                    onclick="document.getElementById('profilePictureInput').click()"
                                    style="width: 32px; height: 32px; padding: 0;">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                        
                        <input type="file" 
                               class="d-none" 
                               id="profilePictureInput" 
                               name="profile_picture" 
                               accept="image/*"
                               onchange="previewImage(this)">
                        
                        <div class="form-text mt-2">
                            Click the camera icon to upload a new profile picture
                        </div>
                    </div>
                    
                    <!-- Form Fields -->
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Full Name *</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-user"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="full_name" 
                                   name="full_name" 
                                   value="{{ user.full_name }}"
                                   required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address *</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-envelope"></i>
                            </span>
                            <input type="email" 
                                   class="form-control" 
                                   id="email" 
                                   name="email" 
                                   value="{{ user.email }}"
                                   required>
                        </div>
                    </div>
                    
                    <!-- Read-only fields -->
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-at"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="username" 
                                   value="{{ user.username }}"
                                   readonly>
                        </div>
                        <div class="form-text">Username cannot be changed</div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="qr_code_id" class="form-label">QR Code ID</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-qrcode"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="qr_code_id" 
                                   value="{{ user.qr_code_id }}"
                                   readonly>
                        </div>
                        <div class="form-text">QR Code ID is automatically generated and cannot be changed</div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-grow-1">
                            <i class="fas fa-save me-2"></i>
                            Save Changes
                        </button>
                        <a href="{{ url_for('client_profile') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Account Info -->
        <div class="card mt-4">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>
                    Account Information
                </h6>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Account Created:</small>
                        <div class="fw-bold">{{ user.created_at.strftime('%B %d, %Y') }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Last Updated:</small>
                        <div class="fw-bold">{{ user.updated_at.strftime('%B %d, %Y') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById('profilePreview');
            
            // Replace the existing preview with new image
            preview.innerHTML = '';
            preview.className = 'rounded-circle';
            preview.style.width = '120px';
            preview.style.height = '120px';
            preview.style.objectFit = 'cover';
            preview.style.backgroundImage = `url(${e.target.result})`;
            preview.style.backgroundSize = 'cover';
            preview.style.backgroundPosition = 'center';
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

// File size and type validation
document.getElementById('profilePictureInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            e.target.value = '';
            return;
        }
        
        // Check file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please select a valid image file (JPEG, PNG, or GIF)');
            e.target.value = '';
            return;
        }
    }
});
</script>
{% endblock %}